<!--
  Painel de Atividades e Calend√°rio Interativo
  Objetivo: Dashboard com calend√°rio, gr√°fico empilhado por status, e gr√°ficos de an√°lise de progresso e dura√ß√£o,
  incluindo an√°lise de texto por IA (OpenAI).
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Avan√ßado de Projetos</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* Configura√ß√£o de Fonte Padr√£o */
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        
        /* Estilos do Calend√°rio */
        .calendar-day-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px 0;
            position: relative;
        }
        .calendar-day-num {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            font-weight: normal;
        }
        .calendar-day-num.active {
            background-color: #4CAF50; /* Verde escuro para dias com atividade */
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .calendar-day-num.selected {
            background-color: #2e7d32; /* Verde mais escuro para o dia selecionado */
        }
        .calendar-day-num:hover:not(.empty) {
            background-color: #d1fae5;
            cursor: pointer;
        }
        .calendar-day-num.empty {
            color: #a0aec0; /* Cinza claro para dias fora do m√™s */
        }
        .activity-count-badge {
            font-size: 0.65rem;
            color: #10B981;
            font-weight: bold;
            line-height: 1;
            margin-top: 2px;
        }
        .calendar-day-wrapper.empty .activity-count-badge {
            display: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- HEADER / T√çTULO -->
        <header class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800">An√°lise de Projetos e Atividades</h1>
            <p class="text-gray-500">Dashboard integrado com busca por data e an√°lise de progresso.</p>
        </header>

        <!-- INPUT DE ARQUIVO CSV -->
        <div class="mb-6 p-4 bg-white shadow-lg rounded-lg">
            <label for="csvFileInput" class="block text-sm font-medium text-gray-700 mb-2">
                Carregar Arquivo CSV de Atividades (Deve incluir colunas: SITE, SUPERVISOR, STATUS DO PROJETO, DATA INICIAL, DATA FINAL)
            </label>
            <input type="file" id="csvFileInput" accept=".csv" class="w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-emerald-50 file:text-emerald-700
                hover:file:bg-emerald-100 cursor-pointer"
            >
            <p id="fileStatus" class="mt-2 text-sm text-gray-500">Aguardando carregamento do arquivo...</p>
        </div>

        <!-- DASHBOARD CONTAINER (GR√ÅFICO EMPILHADO E CALEND√ÅRIO) -->
        <div class="flex flex-col lg:flex-row gap-6">
            
            <!-- COLUNA DO GR√ÅFICO EMPILHADO (W-2/3) -->
            <div class="lg:w-2/3 bg-white p-6 shadow-lg rounded-lg order-2 lg:order-1">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Contagem de Projetos por Status Di√°rio (Baseado na Data de T√©rmino)</h2>
                <div class="h-96">
                    <canvas id="activitiesChart"></canvas>
                </div>
                <p class="text-center text-gray-500 text-sm mt-4">Gr√°fico empilhado mostrando a distribui√ß√£o dos status de projetos por dia.</p>
            </div>

            <!-- COLUNA DO CALEND√ÅRIO E ESTAT√çSTICAS (W-1/3) -->
            <div class="lg:w-1/3 bg-white p-6 shadow-lg rounded-lg order-1 lg:order-2">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Seletor de Data</h2>

                <!-- ESTAT√çSTICAS CHAVE -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm font-medium text-gray-500">Total de Projetos no Per√≠odo</div>
                    <div id="totalActivities" class="text-3xl font-bold text-emerald-600">0</div>
                    <div class="text-sm font-medium text-gray-500 mt-2">M√©dia de Projetos por Dia Finalizado</div>
                    <div id="avgActivities" class="text-xl font-bold text-gray-700">0</div>
                </div>

                <!-- CALEND√ÅRIO -->
                <div id="calendarContainer" class="calendar text-center">
                    <div class="flex justify-between items-center mb-3">
                        <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-200 text-gray-700">
                            &lt;
                        </button>
                        <h3 id="currentMonthYear" class="text-lg font-semibold text-gray-800"></h3>
                        <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-200 text-gray-700">
                            &gt;
                        </button>
                    </div>
                    <div class="grid grid-cols-7 text-xs font-medium text-gray-500 mb-2">
                        <span>Dom</span>
                        <span>Seg</span>
                        <span>Ter</span>
                        <span>Qua</span>
                        <span>Qui</span>
                        <span>Sex</span>
                        <span>S√°b</span>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm">
                        <!-- Dias do calend√°rio ser√£o inseridos aqui pelo JS -->
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- PAINEL DE DETALHES DA ATIVIDADE -->
        <div class="mt-6 bg-white p-6 shadow-lg rounded-lg">
            <h2 id="detailTitle" class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Detalhes da Atividade (Selecione um Dia)</h2>
            <div id="activityDetailTable" class="overflow-x-auto">
                <p class="text-gray-500">Clique em um dia destacado no calend√°rio para ver a lista de projetos.</p>
            </div>
        </div>

        <!-- PAINEL DE AN√ÅLISES ADICIONAIS (GR√ÅFICOS DE DURA√á√ÉO E PROGRESSO) -->
        <div class="mt-6 flex flex-col lg:flex-row gap-6">
            
            <!-- GR√ÅFICO 1: AN√ÅLISE DE DURA√á√ÉO -->
            <div class="lg:w-1/2 bg-white p-6 shadow-lg rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">An√°lise de Dura√ß√£o M√©dia (DATA INICIAL vs DATA FINAL)</h2>
                <div class="h-80">
                    <canvas id="durationChart"></canvas>
                </div>
                <p class="text-center text-gray-500 text-sm mt-4">Dura√ß√£o m√©dia de projetos por SITE.</p>
            </div>

            <!-- GR√ÅFICO 2: PROGRESSO POR SUPERVISOR E AN√ÅLISE DE IA -->
            <div class="lg:w-1/2 bg-white p-6 shadow-lg rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">
                    Progresso Percentual por Supervisor 
                    <button id="analyzeSupervisorBtn" class="ml-2 px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-full hover:bg-blue-700 transition duration-150" onclick="analyzeSupervisorData()">
                        Analisar (IA ‚ú®)
                    </button>
                </h2>
                <div class="h-80 mb-4">
                    <canvas id="supervisorChart"></canvas>
                </div>
                <!-- √Årea de resultado da IA -->
                <div id="aiSupervisorAnalysis" class="mt-2 p-3 border-l-4 border-blue-500 bg-blue-50">
                    <p class="text-sm text-blue-700 font-semibold mb-1">Resumo Executivo da IA:</p>
                    <p id="supervisorAnalysisText" class="text-xs text-gray-700 italic">Clique em 'Analisar (IA ‚ú®)' para gerar um resumo do progresso dos supervisores.</p>
                </div>
            </div>
        </div>

        <!-- NOVO PAINEL DE AN√ÅLISE ESTRUTURADA DE GARGALOS -->
        <div class="mt-6 bg-white p-6 shadow-lg rounded-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">
                Identifica√ß√£o Estruturada de Gargalos (IA ‚ú®)
                <button id="identifyBottlenecksBtn" class="ml-2 px-3 py-1 text-xs font-semibold text-white bg-indigo-600 rounded-full hover:bg-indigo-700 transition duration-150" onclick="identifyBottlenecks()">
                    Analisar Gargalos Ativos (IA ‚ú®)
                </button>
            </h2>
            <div id="bottlenecksResult" class="mt-4">
                <p class="text-gray-500">A IA analisar√° a carga de trabalho de status 'RETIRANDO PEND√äNCIAS' e 'PROGRAMADO' por Supervisor/Cidade e retornar√° os 5 principais gargalos.</p>
            </div>
        </div>


    </div>

    <script>
        // Chave da API OpenAI (Substitu√≠do de Gemini)
        const OPENAI_API_KEY = ""; // COLOQUE SUA CHAVE AQUI
        const OPENAI_MODEL = "gpt-4o-mini"; // Ou gpt-3.5-turbo
        const apiUrl = 'https://api.openai.com/v1/chat/completions'; // Endpoint do OpenAI
        
        // --- CONFIGURA√á√ïES E ESTADO GLOBAL ---
        let rawActivities = [];
        let activitiesData = {}; 
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let chartInstance = null;
        let durationChartInstance = null;
        let supervisorChartInstance = null;
        let supervisorProgressData = {}; 

        const MONTHS_PT = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const STATUS_COLORS = {
            'INSTALADO': 'rgb(67, 160, 71)',       
            'PROGRAMADO': 'rgb(25, 118, 210)',      
            'RETIRANDO PEND√äNCIAS': 'rgb(255, 193, 7)', 
            'INSTALANDO': 'rgb(100, 181, 246)',      
            'ABERTO': 'rgb(189, 189, 189)',         
            'DEFAULT': 'rgb(255, 99, 132)'           
        };
        let csvHeaders = []; 
        const REQUIRED_HEADERS = ['DATA INICIAL', 'STATUS DO PROJETO', 'SUPERVISOR', 'SITE', 'CIDADE', 'DATA FINAL'];

        // --- FUN√á√ïES DE UTENS√çLIOS ---

        /**
         * Tenta analisar string de data (DD/MM/YYYY ou YYYY-MM-DD).
         */
        function parseDate(dateStr) {
            if (!dateStr || dateStr === 'null' || dateStr.toLowerCase() === 'nan') return null;
            dateStr = dateStr.split(' ')[0]; 
            
            const partsDMY = dateStr.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
            if (partsDMY) {
                const [_, day, month, year] = partsDMY;
                const parsedDate = new Date(year, month - 1, day);
                if (!isNaN(parsedDate) && parsedDate.getMonth() == month - 1) {
                    return parsedDate;
                }
            }

            const dateObj = new Date(dateStr);
            if (!isNaN(dateObj)) {
                return dateObj;
            }
            
            return null;
        }

        function dateToYYYYMMDD(dateObj) {
            if (!dateObj) return null;
            return dateObj.toISOString().split('T')[0];
        }

        // Fun√ß√£o para simular o fetch da API com backoff (AGORA PARA OPENAI)
        async function fetchWithBackoff(messages, useJsonSchema = false, maxRetries = 5, delay = 1000) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_API_KEY}`
            };

            const payload = {
                model: OPENAI_MODEL,
                messages: messages,
                temperature: 0.7,
                max_tokens: 1500,
            };

            // Adiciona a especifica√ß√£o JSON se um schema for fornecido
            if (useJsonSchema) {
                payload.response_format = { type: "json_object" };
            }

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 200) {
                        return await response.json();
                    } else if (response.status === 429) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        // Tenta ler o erro do corpo da resposta
                        const errorBody = await response.text();
                        throw new Error(`API returned status ${response.status}. Detalhes: ${errorBody}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }


        // --- FUN√á√ïES DE PROCESSAMENTO DE DADOS ---

        /**
         * Processa o CSV e constr√≥i as estruturas de dados necess√°rias.
         */
        function processCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return;

            const tempRawActivities = [];
            const dataCounts = {};

            // 1. Determinar cabe√ßalhos
            // Usa regex para lidar com cabe√ßalhos entre aspas, mas aqui assume CSV simples para velocidade
            csvHeaders = lines[0].split(',').map(h => h.trim());
            let startIndex = 1;

            if (!REQUIRED_HEADERS.every(h => csvHeaders.includes(h))) {
                document.getElementById('fileStatus').textContent = `AVISO: O CSV deve conter as colunas: ${REQUIRED_HEADERS.join(', ')}. Certifique-se de que o cabe√ßalho esteja na primeira linha.`;
            }

            // 2. Processar linhas de dados
            for (let i = startIndex; i < lines.length; i++) {
                const parts = lines[i].split(',');
                if (parts.length < csvHeaders.length) continue; 
                
                let activity = {};
                csvHeaders.forEach((header, index) => {
                    activity[header] = parts[index] ? parts[index].trim() : '';
                });

                // *** USANDO DATA FINAL ***
                const dateStr = activity['DATA FINAL'];
                const status = activity['STATUS DO PROJETO'] ? activity['STATUS DO PROJETO'].toUpperCase() : 'DEFAULT';
                const dateObj = parseDate(dateStr);

                if (dateObj) {
                    const yyyymmdd = dateToYYYYMMDD(dateObj);
                    
                    if (!dataCounts[yyyymmdd]) {
                        dataCounts[yyyymmdd] = {};
                    }
                    dataCounts[yyyymmdd][status] = (dataCounts[yyyymmdd][status] || 0) + 1;
                    
                    activity.dateKey = yyyymmdd; 
                    tempRawActivities.push(activity);
                }
            }

            rawActivities = tempRawActivities;
            activitiesData = dataCounts;
            
            // Renderiza tudo
            renderCalendar();
            updateStats();
            renderDurationChart();
            renderSupervisorProgressChart();
        }

        // --- OUTRAS FUN√á√ïES (CALEND√ÅRIO, ESTAT√çSTICAS, ETC.) ---

        function updateStats() {
            let total = 0;
            let daysWithActivities = 0;
            
            for (const date in activitiesData) {
                let dailyTotal = 0;
                for(const status in activitiesData[date]) {
                    dailyTotal += activitiesData[date][status];
                }
                total += dailyTotal;
                daysWithActivities++;
            }
            
            const avg = daysWithActivities > 0 ? (total / daysWithActivities).toFixed(1) : 0;
            
            document.getElementById('totalActivities').textContent = total;
            document.getElementById('avgActivities').textContent = avg;
            
            updateChartData(currentYear, currentMonth); 
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function renderCalendar() {
            document.getElementById('currentMonthYear').textContent = `${MONTHS_PT[currentMonth]} ${currentYear}`;
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const startingDay = firstDayOfMonth.getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let i = 0; i < startingDay; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day-wrapper empty';
                dayDiv.innerHTML = '<span class="calendar-day-num"></span><span class="activity-count-badge"></span>';
                calendarGrid.appendChild(dayDiv);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const statusCounts = activitiesData[dateKey] || {};
                let activityCount = 0;
                for(const status in statusCounts) { activityCount += statusCounts[status]; }

                const wrapperDiv = document.createElement('div');
                wrapperDiv.className = 'calendar-day-wrapper';
                
                const dayNumSpan = document.createElement('span');
                dayNumSpan.textContent = day;
                dayNumSpan.className = 'calendar-day-num';

                const countBadge = document.createElement('span');
                countBadge.className = 'activity-count-badge';
                
                if (activityCount > 0) {
                    dayNumSpan.classList.add('active');
                    dayNumSpan.title = `${activityCount} projeto(s) finalizado(s)`;
                    countBadge.textContent = `${activityCount} atv.`;
                    
                    dayNumSpan.addEventListener('click', () => {
                        document.querySelectorAll('.calendar-day-num.selected').forEach(el => el.classList.remove('selected'));
                        dayNumSpan.classList.add('selected');
                        displayActivityDetails(dateKey);
                    });

                } else {
                    countBadge.textContent = '';
                }
                
                wrapperDiv.appendChild(dayNumSpan);
                wrapperDiv.appendChild(countBadge);
                calendarGrid.appendChild(wrapperDiv);
            }
            
            updateChartData(currentYear, currentMonth);
            displayActivityDetails(null); 
        }
        
        function displayActivityDetails(dateKey) {
            const tableContainer = document.getElementById('activityDetailTable');
            const titleElement = document.getElementById('detailTitle');
            
            if (!dateKey) {
                titleElement.textContent = "Detalhes da Atividade (Selecione um Dia)";
                tableContainer.innerHTML = '<p class="text-gray-500">Clique em um dia destacado no calend√°rio para ver a lista de projetos.</p>';
                return;
            }

            // Filtra pela DATA FINAL
            const activitiesForDay = rawActivities.filter(a => a.dateKey === dateKey);
            
            if (activitiesForDay.length === 0) {
                titleElement.textContent = `Detalhes para ${dateKey} (0 Projetos)`;
                tableContainer.innerHTML = '<p class="text-gray-500">Nenhum projeto finalizado nesta data.</p>';
                return;
            }

            titleElement.textContent = `Detalhes da Atividade (Finaliza√ß√µes) para ${dateKey} (${activitiesForDay.length} Projetos)`;

            let tableHTML = `<table class="min-w-full divide-y divide-gray-200 shadow-sm rounded-lg overflow-hidden">`;
            
            tableHTML += `<thead class="bg-gray-50"><tr>`;
            csvHeaders.forEach(header => {
                tableHTML += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`;
            });
            tableHTML += `</tr></thead>`;

            tableHTML += `<tbody class="bg-white divide-y divide-gray-200">`;
            activitiesForDay.forEach(activity => {
                tableHTML += `<tr>`;
                csvHeaders.forEach(header => {
                    const value = activity[header] || '-';
                    tableHTML += `<td class="px-3 py-4 whitespace-nowrap text-xs text-gray-900">${value}</td>`;
                });
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table>`;

            tableContainer.innerHTML = tableHTML;
        }

        // --- FUN√á√ïES DOS GR√ÅFICOS ---

        function updateChartData(year, month) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const labels = [];
            const allStatuses = new Set();
            const datasets = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                labels.push(day);
                if (activitiesData[dateKey]) {
                    Object.keys(activitiesData[dateKey]).forEach(status => allStatuses.add(status));
                }
            }
            
            allStatuses.forEach(status => {
                const statusData = [];
                labels.forEach(day => {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    statusData.push(activitiesData[dateKey]?.[status] || 0);
                });

                datasets.push({
                    label: status,
                    data: statusData,
                    backgroundColor: STATUS_COLORS[status] || STATUS_COLORS.DEFAULT,
                    stack: 'Stack 1'
                });
            });

            renderStackedChart(labels, datasets);
        }

        function renderStackedChart(labels, datasets) {
            const ctx = document.getElementById('activitiesChart').getContext('2d');
            if (chartInstance) { chartInstance.destroy(); }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'Dia do M√™s' } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'N¬∫ de Projetos' } }
                    },
                    plugins: { legend: { position: 'top' }, title: { display: false } }
                }
            });
        }
        
        function renderDurationChart() {
            const durationAnalysis = {};
            
            rawActivities.forEach(activity => {
                const startDate = parseDate(activity['DATA INICIAL']);
                const endDate = parseDate(activity['DATA FINAL']);
                const site = activity['SITE'];
                
                if (startDate && endDate && site) {
                    const durationMs = endDate - startDate;
                    const durationDays = Math.max(0, durationMs / (1000 * 60 * 60 * 24)); 
                    
                    if (!durationAnalysis[site]) {
                        durationAnalysis[site] = { totalDuration: 0, count: 0 };
                    }
                    durationAnalysis[site].totalDuration += durationDays;
                    durationAnalysis[site].count++;
                }
            });

            const labels = [];
            const data = [];
            
            Object.keys(durationAnalysis).forEach(site => {
                const avg = durationAnalysis[site].totalDuration / durationAnalysis[site].count;
                labels.push(site);
                data.push(avg.toFixed(1));
            });
            
            const ctx = document.getElementById('durationChart').getContext('2d');
            if (durationChartInstance) durationChartInstance.destroy();

            durationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Dura√ß√£o M√©dia (dias)',
                        data: data,
                        backgroundColor: '#FF6384',
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'M√©dia de Dias' } } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'M√©dia de Dura√ß√£o (DATA FINAL - DATA INICIAL)' } }
                }
            });
        }
        
        function renderSupervisorProgressChart() {
            const supervisorProgress = {};
            const relevantStatuses = ['INSTALADO', 'PROGRAMADO', 'RETIRANDO PEND√äNCIAS'];
            
            rawActivities.forEach(activity => {
                const supervisor = activity['SUPERVISOR'] || 'N√£o Atribu√≠do';
                const status = activity['STATUS DO PROJETO'] ? activity['STATUS DO PROJETO'].toUpperCase() : 'DEFAULT';

                if (!supervisorProgress[supervisor]) {
                    supervisorProgress[supervisor] = { total: 0 };
                    relevantStatuses.forEach(s => supervisorProgress[supervisor][s] = 0);
                }
                
                supervisorProgress[supervisor].total++;
                if (relevantStatuses.includes(status)) {
                    supervisorProgress[supervisor][status] = (supervisorProgress[supervisor][status] || 0) + 1;
                }
            });
            
            supervisorProgressData = supervisorProgress; 
            let analysisText = '';
            
            Object.keys(supervisorProgress).forEach(supervisor => {
                const installedCount = supervisorProgress[supervisor]['INSTALADO'] || 0;
                const totalCount = supervisorProgress[supervisor].total;
                const percentageCompleted = (installedCount / totalCount) * 100;
                
                analysisText += `**${supervisor}**: ${totalCount} projetos no total. Progresso de Instala√ß√£o: ${percentageCompleted.toFixed(1)}%. ;`;
            });

            const totalStatusCounts = {};
            rawActivities.forEach(activity => {
                const status = activity['STATUS DO PROJETO'] ? activity['STATUS DO PROJETO'].toUpperCase() : 'DEFAULT';
                totalStatusCounts[status] = (totalStatusCounts[status] || 0) + 1;
            });
            
            const chartLabels = Object.keys(totalStatusCounts).filter(status => relevantStatuses.includes(status));
            const chartData = chartLabels.map(status => totalStatusCounts[status]);
            const chartColors = chartLabels.map(status => STATUS_COLORS[status] || STATUS_COLORS.DEFAULT);

            const ctx = document.getElementById('supervisorChart').getContext('2d');
            if (supervisorChartInstance) supervisorChartInstance.destroy();

            supervisorChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Distribui√ß√£o Total de Status',
                        data: chartData,
                        backgroundColor: chartColors,
                        borderColor: '#ffffff',
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: 'Distribui√ß√£o GERAL de Status (Todos os Supervisores)' }
                    }
                }
            });
            
            document.getElementById('supervisorAnalysisText').innerHTML = analysisText.replace(/;/g, '<br>');
        }
        
        // --- FUN√á√ïES DE INTEGRA√á√ÉO COM OPENAI API (CHAT GPT) ---

        async function analyzeSupervisorData() {
            if (!OPENAI_API_KEY) {
                alert("Por favor, insira sua chave de API do OpenAI no c√≥digo.");
                return;
            }

            const outputElement = document.getElementById('aiSupervisorAnalysis');
            outputElement.innerHTML = `<p class="text-sm text-blue-700 font-semibold mb-1">Resumo Executivo da IA:</p><p class="text-xs text-gray-700 italic">Aguarde, analisando dados de progresso...</p>`;
            
            const supervisorDataJson = JSON.stringify(supervisorProgressData, null, 2);
            const prompt = `Analise os seguintes dados de progresso de projeto, agrupados por supervisor e status, e gere um resumo executivo conciso em portugu√™s. Identifique o supervisor com o melhor desempenho (maior % INSTALADO) e o supervisor com a maior necessidade de aten√ß√£o (maior % RETIRANDO PEND√äNCIAS/PROGRAMADO). Dados: ${supervisorDataJson}`;
            
            const messages = [
                { role: "system", content: "Voc√™ √© um analista de projetos experiente. Sua resposta deve ser em portugu√™s, profissional e ter no m√°ximo 4 frases, focando em identificar o melhor e o pior desempenho." },
                { role: "user", content: prompt }
            ];

            try {
                const result = await fetchWithBackoff(messages);
                const text = result?.choices?.[0]?.message?.content || "Falha ao gerar o resumo. Tente novamente.";
                
                outputElement.innerHTML = `<p class="text-sm text-blue-700 font-semibold mb-1">Resumo Executivo da IA:</p><p class="text-xs text-gray-700">${text}</p>`;

            } catch (error) {
                outputElement.innerHTML = `<p class="text-sm text-red-700 font-semibold mb-1">Resumo Executivo da IA:</p><p class="text-xs text-red-700">Erro na comunica√ß√£o com a API: ${error.message}</p>`;
            }
        }

        async function identifyBottlenecks() {
            if (!OPENAI_API_KEY) {
                alert("Por favor, insira sua chave de API do OpenAI no c√≥digo.");
                return;
            }
            
            const outputElement = document.getElementById('bottlenecksResult');
            outputElement.innerHTML = `<p class="text-gray-700 italic">Aguarde, a IA est√° analisando gargalos...</p>`;

            const bottleneckActivities = rawActivities.filter(a => {
                const status = a['STATUS DO PROJETO'] ? a['STATUS DO PROJETO'].toUpperCase() : '';
                return status === 'RETIRANDO PEND√äNCIAS' || status === 'PROGRAMADO';
            });

            // Se n√£o houver dados pendentes, saia
            if (bottleneckActivities.length === 0) {
                outputElement.innerHTML = `<p class="text-gray-500">Nenhum projeto em status de gargalo ('RETIRANDO PEND√äNCIAS' ou 'PROGRAMADO') para analisar.</p>`;
                return;
            }

            const bottleneckData = bottleneckActivities.map(a => 
                `Supervisor: ${a['SUPERVISOR']}, Cidade: ${a['CIDADE']}, Status: ${a['STATUS DO PROJETO']}, Site: ${a['SITE']}`
            ).join('\n');
            
            const prompt = `Analise a lista de projetos pendentes e em programa√ß√£o ('RETIRANDO PEND√äNCIAS' e 'PROGRAMADO'). Identifique os 3 principais fatores de gargalo com base na concentra√ß√£o de trabalho (Supervisor, Cidade ou Status) e retorne o resultado em formato JSON. O JSON deve ser um array de objetos, onde cada objeto tem as chaves: 'fator', 'total_pendente', e 'prioridade' ('Alta', 'M√©dia', ou 'Baixa').`;
            
            const messages = [
                { role: "system", content: "Voc√™ √© um analista de projetos. Retorne APENAS o array JSON estrito, sem pre√¢mbulos ou texto explicativo. O array deve conter 3 objetos representando os 3 principais gargalos." },
                { role: "user", content: `${prompt}\n\nDados:\n${bottleneckData}` }
            ];
            
            try {
                const result = await fetchWithBackoff(messages, true);
                
                const jsonText = result?.choices?.[0]?.message?.content;
                
                // Tenta limpar e analisar o JSON
                const cleanJsonMatch = jsonText ? jsonText.match(/\[.*\]/s) : null; 
                if (cleanJsonMatch === null) { 
                    throw new Error("API retornou um texto inv√°lido ou n√£o retornou um array JSON estrito.");
                }
                const cleanJsonText = cleanJsonMatch[0];
                const parsedJson = JSON.parse(cleanJsonText);
                
                // Mapeamento e renderiza√ß√£o (corrigido o erro de toLowerCase)
                let tableHTML = `<table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50"><tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Fator de Gargalo</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Total Pendente</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-indigo-700 uppercase">Prioridade</th>
                    </tr></thead><tbody>`;
                parsedJson.forEach(item => {
                    // VERIFICA√á√ÉO DE SEGURAN√áA CORRIGIDA: Garante que prioridade seja uma string antes de toLowerCase
                    const priority = (item.prioridade || '').toString().toLowerCase(); 
                    let color = 'bg-gray-100'; // Default
                    if (priority === 'alta') {
                        color = 'bg-red-100';
                    } else if (priority === 'm√©dia') {
                        color = 'bg-yellow-100';
                    } else if (priority === 'baixa') {
                        color = 'bg-green-100';
                    }

                    tableHTML += `<tr class="${color}">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.fator || '-'}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${item.total_pendente || 0}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${item.prioridade || 'N/A'}</td>
                    </tr>`;                });
                tableHTML += `</tbody></table>`;
                
                outputElement.innerHTML = tableHTML;

            } catch (error) {
                outputElement.innerHTML = `<p class="text-sm text-red-700">Erro na comunica√ß√£o com a API ou formato JSON inv√°lido: ${error.message}</p><p class="text-xs text-gray-500">Verifique o console para mais detalhes (F12).</p>`;
                console.error("Erro na an√°lise estruturada da IA:", error);
            }
        }
        // --- FUN√á√ÉO DE INICIALIZA√á√ÉO E UPLOAD ---
        function initApp() {
            renderCalendar();

            const fileInput = document.getElementById('csvFileInput');
            const fileStatus = document.getElementById('fileStatus');

            // Corrige escopo global de fun√ß√µes usadas no HTML
            window.changeMonth = changeMonth;
            window.analyzeSupervisorData = analyzeSupervisorData;
            window.identifyBottlenecks = identifyBottlenecks;
            window.processCSV = processCSV; // üî• garante que processCSV seja vis√≠vel globalmente

            // --- EVENTO DE UPLOAD DO CSV ---
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileStatus.textContent = `Arquivo carregado: ${file.name}. Processando...`;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const csvText = e.target.result;
                            processCSV(csvText); // ‚úÖ processa CSV real
                            fileStatus.textContent = `Arquivo '${file.name}' processado com sucesso!`;
                        } catch (error) {
                            fileStatus.textContent = `Erro ao processar o CSV: ${error.message}`;
                            console.error(error);
                        }
                    };
                    reader.readAsText(file);
                }
            });

            // --- CSV DE EXEMPLO (caso nenhum arquivo seja carregado) ---
            const exampleCSV = `SITE,Informa√ß√µes,CIDADE,UF,COORDENADOR,SUPERVISOR,Equipe,RETIRADA DO MATERIAL,DATA INICIAL,DATA FINAL,STATUS DO PROJETO,Outros
        PTA0045,Levar RB, Petrolina,PE,FERNANDO,Joao,Jose Welton,22/10/2025,22/10/2025,24/10/2025,INSTALADO,MOCK
        PTA0042,Levar RB da Sede, Petrolina,PE,FERNANDO,Joao,Jose Welton,23/10/2025,24/10/2025,25/10/2025,PROGRAMADO,MOCK
        PTA0003,Instala√ß√£o de Kit radio, Petrolina,PE,FERNANDO,Joao,Jose Welton,24/10/2025,25/10/2025,28/10/2025,INSTALADO,MOCK
        JUO0015.1,Equipe deve ir p/ site, Juazeiro,BA,FERNANDO,Joao,Jose Welton,29/10/2025,29/10/2025,30/10/2025,RETIRANDO PEND√äNCIAS,MOCK
        PTA0044,Instala√ß√£o de Kit radio, Petrolina,PE,SUPERVISOR ES,Leonardo,Cleverton,20/10/2025,21/10/2025,23/10/2025,PROGRAMADO,MOCK
        VIS0006,Fazer enlace radio, Vertentes,PE,SUPERVISOR ES,Leonardo,Cleverton,25/10/2025,27/10/2025,28/10/2025,RETIRANDO PEND√äNCIAS,MOCK
        VTS0004,Comunicar c/ Eletrica, Vertentes,PE,SUPERVISOR ES,Leonardo,Cleverton,28/10/2025,29/10/2025,30/10/2025,RETIRANDO PEND√äNCIAS,MOCK
        GVT0012.1,Instalar o Enlace, Gravata,PE,SUPERVISOR ES,Leonardo,Cleverton,29/10/2025,29/10/2025,30/10/2025,RETIRANDO PEND√äNCIAS,MOCK
        PTA0046,Instalar Kit radio, Petrolina,PE,SUPERVISOR ES,Leonardo,Frankleomar,20/10/2025,21/10/2025,23/10/2025,PROGRAMADO,MOCK
        JRO0005,Instala√ß√£o kit r√°dio, Jeremoabo,BA,SUPERVISOR ES,Leonardo,Frankleomar,23/10/2025,24/10/2025,27/10/2025,PROGRAMADO,MOCK
        PSS0005,Levar SW p/ ser instalado, Passira,PE,SUPERVISOR ES,Leonardo,Frankleomar,29/10/2025,29/10/2025,29/10/2025,RETIRANDO PEND√äNCIAS,MOCK
        PTA0049,Instala√ß√£o de Kit radio, Petrolina,PE,SUPERVISOR ES,Natanael,Jose Welton,20/10/2025,21/10/2025,22/10/2025,INSTALADO,MOCK`;

            // Define m√™s e ano padr√£o
            currentMonth = 9; // Outubro (0-indexado)
            currentYear = 2025;

            // --- CARREGAMENTO AUTOM√ÅTICO DO EXEMPLO ---
            setTimeout(() => {
                try {
                    fileStatus.textContent = "Nenhum arquivo carregado. Exibindo exemplo...";
                    processCSV(exampleCSV); // ‚úÖ carrega CSV exemplo
                    fileStatus.textContent = "Exemplo carregado com sucesso!";
                } catch (error) {
                    console.error("Erro ao carregar CSV de exemplo:", error);
                }
            }, 1000);
        }
